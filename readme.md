# Node.js Remote Web Controller (Room-Based Hybrid Architecture)

This project implements a real-time interactive system using Node.js, Express, and Socket.IO. It utilizes a **room-based hybrid architecture** to allow multiple independent instances of a display page (`app.html`) to be controlled remotely by devices accessing a controller page (`controller.html`). An **Admin View** (`/admin`) is also available to monitor active rooms and controller status.

Each `app.html` instance creates a unique, **4-letter uppercase Room Code**. Controllers connect to a specific room using either a **QR code** generated by the app instance or by **manually entering the case-insensitive Room Code** on the controller page.

The architecture prioritizes **low-latency responsiveness** by having the server act primarily as a **smart relay** for core interactions (`cursor_move`, `tap`). The `app.html` client within that room processes these events *locally* for immediate visual feedback. The server manages authoritative state like keyboard mode *per room*, handles connection/reconnection logic, tracks controller presence, and provides room status updates to the admin view.

**Core Functionality:**

-   **Independent App Instances:** Creates unique, 4-letter uppercase Room Codes.
-   **Room-Specific Control:** Controllers join via QR or manual code entry (case-insensitive).
-   **Responsive Hybrid Control:** Server relays events; App processes locally.
-   **Virtual Cursor & Visual Feedback:** App displays cursor, hover, focus effects locally.
-   **Remote Keyboard (Per Room):** Server processes keys based on room state; relays to app.
-   **App Session Persistence:** App attempts to rejoin its room after refresh using `sessionStorage`.
-   **Controller Fallback:** `/controller` prompts for manual code entry if accessed directly.
-   **Admin Monitoring View (`/admin`):**
    -   Displays a **real-time list** of active Room Codes.
    -   Shows **controller status indicator** (green dot if controllers connected, red if not) for each room.
    -   Allows selecting a room to **"peek"** into (read-only).
    -   Shows **live updates** for the peeked room: cursor visibility, position, focused element, and value.
    -   (**Note:** Admin view currently has no authentication).

**Components:**

-   **Server (`server.js`):** Node.js + Express + Socket.IO server.
    -   Manages rooms (keyed by 4-letter uppercase codes) and **per-room state** (`roomStates` Map).
    -   Generates room codes, handles app/controller/admin registration and app rejoins.
    -   Tracks connected controllers per room (`roomState.controllerSocketIds`).
    -   Relays validated controller events (`cursor_move`, `tap`, `key_input`) to the correct room/app.
    -   Broadcasts granular state updates (`cursor_position_update`, `focus_update`) to rooms based on app reports.
    -   **Broadcasts controller status changes** (`room_controller_status`) to admins when controllers join/leave.
    -   Broadcasts room lifecycle events (`room_created`, `room_destroyed`) to admins.
    -   Handles admin peek requests/stops.
-   **App Display (`public/app.html`):** The target web page (root URL `/`).
    -   Requests/rejoins a room, gets/stores 4-letter code, generates QR code.
    -   Processes relayed events (`cursor_move`, `tap`, `key_input`) **locally**.
    -   Reports state changes (`report_cursor_position`, `report_focus_change`) back to server.
    -   Receives `set_cursor_visibility` broadcasts.
-   **Touch Controller (`public/controller.html`):** The remote control interface (URL `/controller`).
    -   Joins room via URL parameter or **manual code entry**.
    -   Sends interaction events (`cursor_move`, `tap`, `key_input`) **with Room Code**.
    -   Receives room-specific keyboard state (`update_controller_state`).
    -   Displays connection status/errors.
-   **Admin View (`public/admin.html`):** Monitoring interface (URL `/admin`).
    -   Registers as admin, receives initial room list with controller status.
    -   Displays room list with **green/red status indicators**.
    -   Receives **live updates** for room creation/destruction and **controller status changes** (`room_controller_status`).
    -   Handles peeking (joins room, receives initial state and live updates).

---

## Features

-   Hybrid Architecture for Responsiveness
-   Room-Based Isolation
-   Real-time Interaction within Rooms
-   Simple 4-Letter Room Codes (Case-Insensitive Join)
-   Multiple Connection Methods (QR, Manual Entry)
-   Controller Manual Entry Fallback
-   App Session Persistence (Refresh Recovery)
-   **Admin View:**
    -   Real-time list of active rooms.
    -   **Controller presence indicators (Green/Red dots).**
    -   Read-only "peek" functionality into selected rooms.
    -   Live updates of cursor position, visibility, and focus state in peek view.
-   Remote Cursor Control & Keyboard Input (Per Room)
-   Local Visual Hover/Focus Indication
-   Server-Managed Keyboard State (Per Room)
-   Robust Connection Handling

---

## Installation & Running

### Prerequisites

-   Node.js and npm

### Steps

1.  Clone/Download repository.
2.  Install Dependencies: `npm install express socket.io qrcode`

### Running Locally

1.  Start Server: `node server.js`
2.  Open App Display: `http://localhost:3000/` (Note the 4-letter Room Code)
3.  Open Admin View (Optional): `http://localhost:3000/admin` (Observe room list and status dots)
4.  Connect Controller: Use QR code or manual entry for the desired room code.
5.  Observe Admin View: The status dot for the corresponding room should turn green.
6.  Interact: Use controller; observe App Display and Admin View updates.
7.  Disconnect Controller: Close the controller tab/browser. Observe the status dot turn red on the Admin View.

---

## Deployment to Heroku

(Ensure `qrcode` is added to `package.json`. Steps remain the same.)

---

## How It Works (Room-Based Hybrid + Admin Status)

1.  **App/Controller Connection:** (As before).
2.  **Admin Connection:**
    -   Admin connects, registers.
    -   Server sends `initial_room_list` containing an array of `{ code, hasControllers }` objects.
    -   Admin client stores this data (e.g., in a Map) and renders the list with initial status indicators.
3.  **Controller Status Changes:**
    -   **Join:** When the *first* controller joins a room, the server emits `room_controller_status` `{ code, hasControllers: true }` to all admins.
    -   **Leave:** When the *last* controller leaves a room, the server emits `room_controller_status` `{ code, hasControllers: false }` to all admins.
    -   **Admin Client (`room_controller_status`):** Updates its internal status map for the specific room code and re-renders the list (or just the specific list item) to show the new green/red dot.
4.  **Room Creation/Destruction:**
    -   `room_created` now includes initial `{ code, hasControllers: false }`.
    -   `room_destroyed` sends just the `code`.
    -   Admin client adds/removes entries from its status map accordingly and re-renders.
5.  **Peeking & Event Broadcasting:** (As described before - admin joins room, server broadcasts updates *to the room*).

---

## Troubleshooting

<!-- ... Add points specific to Admin View Status ... -->
-   **Admin View - Status Indicators Incorrect/Not Updating:**
    -   Check server console: Is it correctly detecting the *first* controller joining and the *last* controller leaving a room? Is it broadcasting `room_controller_status` with the correct `code` and `hasControllers` value?
    -   Check admin console: Is it receiving `room_controller_status` events? Is the `updateRoomControllerStatus` function correctly finding the room in its map and updating the `hasControllers` property? Is `renderRoomList` being called after the update?
    -   Check admin console for errors in `renderRoomList` when applying `has-controllers`/`no-controllers` classes.
    -   Ensure the CSS rules for `::before` and the status classes are correct.


---

## CHANGELOG

**Recent Changes (Admin View Enhancements)**

-   **Admin - Controller Status:**
    -   Server now tracks the number of connected controllers per room.
    -   Server sends initial controller status (`hasControllers: true/false`) with the room list to admins.
    -   Server broadcasts `room_controller_status` updates to admins when the first controller joins or the last controller leaves a room.
    -   Admin client (`admin.html`) now displays a **green/red status indicator** next to each room code based on controller presence. It uses a Map (`roomControllerStatus`) to track this state and updates the list dynamically upon receiving status events.
-   **Admin - State Management:** Refactored `admin.html` state management to use a Map keyed by room code, storing controller status, improving reliability after server restarts.
-   **Admin - Real-time Peek Fixes:** Ensured server correctly broadcasts absolute cursor position (`cursor_position_update`) and focus changes (`focus_update`) to the room when reported by the app, allowing the peek view to update live. Corrected client-side logic for handling these granular updates.
-   **Code Structure:** Updated server event emissions and admin client event handling for status updates. Simplified admin client rendering logic.