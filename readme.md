# Node.js Remote Web Controller (Room-Based Hybrid Architecture)

This project implements a real-time interactive system using Node.js, Express, and Socket.IO. It utilizes a **room-based hybrid architecture** to allow multiple independent instances of a display page (`app.html`) to be controlled remotely by devices accessing a controller page (`controller.html`).

Each `app.html` instance creates a unique, short **Room ID**. Controllers connect to a specific room using either a **QR code** generated by the app instance or by **manually entering the Room ID** on the controller page.

The architecture prioritizes **low-latency responsiveness** by having the server act primarily as a **smart relay** for core interactions (`cursor_move`, `tap`), broadcasting them only within the designated room. The `app.html` client within that room processes these events *locally* for immediate visual feedback. The server manages authoritative state like keyboard mode *per room* and handles connection/reconnection logic.

**Core Functionality:**

-   **Independent App Instances:** Open multiple `app.html` pages; each gets a unique, short **Room ID**.
-   **Room-Specific Control:** Controllers connect to *one specific* `app.html` instance via its Room ID.
    -   Scan the **QR Code** displayed on `app.html`.
    -   Or, navigate directly to `/controller` and **manually enter the Room ID**.
-   **Responsive Hybrid Control:**
    -   Controller sends raw movement (`cursor_move`) and tap (`tap`) events with the Room ID to the server.
    -   Server validates the controller belongs to the room and instantly **relays** the event *only* to the corresponding `app.html` instance.
    -   `app.html` receives the relayed event and **processes it locally** (updates cursor position, handles hover, simulates click/focus) for minimal lag.
-   **Virtual Cursor:** `app.html` displays a virtual cursor (red dot) controlled by relayed movements.
-   **Visual Hover/Focus:** `app.html` locally determines and displays hover (green outline/underline) and focus (blue outline) effects based on cursor position and relayed taps.
-   **Remote Keyboard (Per Room):**
    -   Controller sends raw key presses (`key_input`) with Room ID to the server.
    *   Server determines the correct character/command based on the *room's* keyboard state (mode/shift).
    *   Server relays the *processed* key event to the specific `app.html` instance.
    *   `app.html` updates the locally focused input field.
    -   Controller keyboard UI updates based on state sent by the server for its room.
-   **App Session Persistence:** `app.html` uses `sessionStorage` to remember its Room ID, allowing it to **rejoin the same room** after a page refresh (if the room still exists on the server).
-   **Controller Fallback:** If `/controller` is accessed without a `?room=` parameter, it prompts the user to manually enter a Room ID.

**Components:**

-   **Server (`server.js`):** Node.js + Express + Socket.IO server.
    -   Manages multiple **rooms**, identified by short IDs (`shortid` library).
    -   Stores **per-room state** (`roomStates` Map), including controller lists, keyboard state, and last known app state for rejoins.
    -   Handles app registration (`register_app_room`), assigns Room ID, handles app rejoin attempts (`rejoin_app_room`).
    -   Handles controller registration (`register_controller_room`), validating against existing rooms.
    -   **Validates and relays** controller events (`cursor_move`, `tap`) *within the correct room*.
    -   **Processes keyboard events (`key_input`)** based on per-room state and relays the result to the app in that room.
    -   Manages client disconnections and room cleanup (or persistence for rejoins).
-   **App Display (`public/app.html`):** The target web page (root URL `/`). Each instance is independent.
    -   On connect, requests a room (`register_app_room`). If reconnecting after refresh, attempts to rejoin its previous room (`rejoin_app_room`) using ID from `sessionStorage`.
    -   Receives its assigned short **Room ID** (`your_room_id`).
    -   Stores Room ID in `sessionStorage`.
    -   Generates a **QR Code** containing the controller URL with its specific Room ID (`/controller?room=...`).
    -   Receives **relayed events** (`cursor_move`, `tap`, `key_input`) from the server for its room.
    -   **Processes events locally** for responsive UI updates (cursor, hover, focus, typing).
    -   Reports its state changes (`report_cursor_position`, `report_focus_change`) back to the server (with Room ID) for sync/rejoin purposes.
-   **Touch Controller (`public/controller.html`):** The remote control interface (URL `/controller`).
    -   Checks URL for `?room=` parameter on load.
    -   If parameter exists, attempts to join that room (`register_controller_room`).
    -   If parameter is missing, displays a **manual entry form** for the Room ID.
    -   Sends all interaction events (`cursor_move`, `tap`, `key_input`) **with the target Room ID** to the server.
    -   Receives room-specific keyboard state (`update_controller_state`) from the server to update its UI.
    -   Displays connection status and error messages.

---

## Features

-   **Hybrid Architecture:** Combines client-side processing for responsiveness with server-side relay and state management for consistency and rooms.
-   **Room-Based Isolation:** Allows multiple independent `app.html` instances, each controllable separately.
-   **Real-time Interaction:** Low-latency cursor movement and interaction within each room.
-   **Short, User-Friendly Room IDs:** Uses `shortid` for easier manual entry.
-   **Multiple Connection Methods:** Join a room via QR Code or Manual ID Entry.
-   **Controller Manual Entry Fallback:** Gracefully handles direct navigation to the controller page.
-   **App Session Persistence:** App instances attempt to rejoin their room after a page refresh using `sessionStorage`.
-   **Remote Cursor Control:** Virtual trackpad functionality per room.
-   **Local Visual Hover/Focus Indication:** Responsive green/blue outlines processed by the app client.
-   **Server-Managed Keyboard State (Per Room):** Consistent keyboard mode/shift handling within a room.
-   **Remote Text Input:** Type on the controller into the locally focused element on the app page.
-   **Robust Connection Handling:** Manages disconnections, rejoins, invalid rooms, and app owner departures.

---

## Installation & Running

### Prerequisites

-   **Node.js and npm**
-   **Git** (Optional)

### Steps

1.  **Clone/Download** the repository.
    ```bash
    git clone <your-repo-url>
    cd <your-project-folder>
    ```
2.  **Install Dependencies:**
    ```bash
    npm install express socket.io shortid qrcode
    # Or just: npm install
    ```

### Running Locally

1.  **Start the Server:**
    ```bash
    node server.js
    # Or if you have nodemon: npm run dev
    ```
    Server starts (usually `http://localhost:3000`). Note your machine's local IP address if connecting from other devices (e.g., `192.168.X.Y`).

2.  **Open the App Display:**
    Navigate a browser (e.g., on your desktop) to: `http://localhost:3000/`
    -   The app connects and receives a unique short **Room ID**.
    -   A **QR code** is generated. The text below it shows the Room ID.

3.  **Open Another App Display (Optional):**
    Open `http://localhost:3000/` in a *different* browser tab or window. It will get its *own* unique Room ID and QR code, operating independently.

4.  **Connect a Controller:**
    *   **Method 1: QR Code:** Scan the QR code displayed on the desired `app.html` instance using your mobile device (must be on the same network). This opens `/controller?room=<RoomID>`.
    *   **Method 2: Manual Entry:** On your mobile device's browser, navigate directly to `http://<your-server-ip>:3000/controller` (replace `<your-server-ip>`). Enter the **Room ID** shown on the target `app.html` instance and click "Join Room".

5.  **Interact:**
    -   Controller connects to the specific room -> Status updates -> Red cursor appears on the corresponding `app.html` page.
    -   **Move Cursor:** Drag with one finger on the controller's touch area. The server relays deltas, the *app* calculates the new position and updates instantly.
    -   **Observe Hover:** Interactive elements on the *target app* get a green outline/underline immediately as the *app* processes cursor movement.
    -   **Simulate Click / Focus:** Tap quickly with one finger (or right-click/two-finger tap). The server relays the tap, the *app* finds the element and performs focus/click locally.
    -   **Observe Focus:** Tap a text field -> it gets a blue outline on the *target app*.
    -   **Type Text:** Use the controller keyboard. Raw key info is sent to the server, which processes it based on the room's keyboard state and relays the final character/command to the *target app*, which updates the input field.
    -   **Switch Keyboard:** Use "?123", "ABC", "â‡§" keys. Controller sends toggle requests, server updates the room's keyboard state and broadcasts the update back to *all controllers in that room*.
    -   **Refresh App:** Refresh the `app.html` page. It should automatically attempt to rejoin its previous room using the ID from `sessionStorage`.

---

## Deployment to Heroku

(Standard Heroku Node.js deployment steps)

1.  Ensure `package.json` includes `express`, `socket.io`, `shortid`, `qrcode`.
2.  Ensure `engines` field in `package.json` specifies Node version.
3.  Ensure `Procfile` exists (e.g., `web: node server.js`).
4.  Login (`heroku login`), Create App (`heroku create`), Commit code (`git commit -m "Implement room-based hybrid architecture"`).
5.  Push to Heroku (`git push heroku main`).
6.  Open deployed app (`heroku open`). Use QR code or manual entry (using the Heroku app URL for the controller).

---

## How It Works (Room-Based Hybrid)

1.  **App Connection & Room Creation:**
    -   `app.html` connects.
    -   Checks `sessionStorage` for `remoteControlRoomId`.
    -   If found, emits `rejoin_app_room` with the stored ID.
    -   If not found, emits `register_app_room`.
    -   **Server (`register_app_room`):** Generates unique short ID, creates `roomState` entry in `roomStates` Map (key=shortId, value=state object containing `appSocketId`), makes app socket `join()` the Socket.IO room (named with short ID), emits `your_room_id` back to app.
    -   **Server (`rejoin_app_room`):** Finds room state by short ID. If found, updates `appSocketId` to the new socket.id, makes app socket `join()` the room, emits `your_room_id` and current `initial_state`. If not found, emits `rejoin_failed`.
    -   **App (`your_room_id`):** Stores received short ID in `assignedRoomId` variable and in `sessionStorage`. Generates QR code.
2.  **Controller Connection:**
    -   `controller.html` connects.
    -   Gets Room ID from URL (`?room=...`) or prompts for manual entry.
    -   Emits `register_controller_room` with the target short Room ID.
    -   **Server:** Finds room state by short ID. If valid, adds controller's `socket.id` to `roomState.controllerSocketIds`, makes controller `join()` the Socket.IO room (named with short ID), sends current `update_controller_state`. If invalid, emits `invalid_room`.
3.  **Event Relaying (Controller -> App):**
    -   Controller sends `cursor_move`, `tap`, `key_input` with `{ roomId: targetRoomId, ... }`.
    -   **Server:** Receives event, looks up `roomState` using `data.roomId`. Validates sender `socket.id` is in `roomState.controllerSocketIds`.
    -   **Server (Cursor/Tap):** Relays event *only* to the `roomState.appSocketId` using `io.to(roomState.appSocketId).emit(...)`.
    -   **Server (Key Input):** Processes key based on `roomState.controllerState` (mode/shift), determines `keyToBroadcast`, relays processed key *only* to `roomState.appSocketId`. If mode/shift changed, broadcasts `update_controller_state` to *all controllers in the room*.
4.  **App Event Handling:**
    -   `app.html` receives relayed `cursor_move`, `tap`, `key_input`.
    -   Processes these events **locally** to update cursor, hover, focus, and input values immediately.
5.  **App State Reporting (for Sync/Rejoin):**
    -   After local updates (cursor move, focus change, typing), `app.html` emits `report_cursor_position` or `report_focus_change` with `{ roomId: assignedRoomId, ... }`.
    -   **Server:** Receives report, validates sender is the `appSocketId` for that room, updates the `roomState.lastKnown...` values. This data is *only* used for sending `initial_state` to joining/rejoining apps.

---

## Troubleshooting

-   **Cannot Join Room (Controller):**
    -   Check URL parameter `?room=` or manual entry matches the ID shown on `app.html` *exactly*. Short IDs are case-sensitive.
    -   Check server console for "Room not found" warnings. Ensure `app.html` connected first and received its ID.
    -   Check controller console for `invalid_room` events.
-   **No Cursor Movement/Interaction:**
    -   Verify controller joined the correct room (check status message, server logs).
    -   Check controller console to ensure events (`cursor_move`, `tap`) are being sent *with the correct `roomId`*.
    -   Check server console logs: Is it receiving the events? Is the validation `roomState && roomState.controllerSocketIds.has(socket.id)` passing? Is it attempting to emit to the `appSocketId`? Is the `appSocketId` logged correctly?
    -   Check app console: Is it receiving the relayed `cursor_move`, `tap` events? Are there errors in the local processing handlers (`updateCursorPosition`, `handleManualHover`, tap handler)?
-   **App Refresh Creates New Room (Rejoin Fails):**
    -   Check app browser's `sessionStorage` (Developer Tools -> Application -> Session Storage) to ensure `remoteControlRoomId` is being stored correctly *before* refresh.
    -   Check app console on reconnect: Is it logging "Found previous room ID"? Is it emitting `rejoin_app_room`?
    -   Check server console: Is it receiving `rejoin_app_room`? Is it finding the room state? Is it logging "successfully REJOINED"? Or is it logging "Room not found"? (Maybe server restarted, clearing `roomStates`).
    -   Check app console: Is it receiving `rejoin_failed`?
-   **Keyboard Mode/Shift Not Updating on Controller:**
    -   Check controller console: Is it sending `ToggleMode`/`ToggleShift` events with the `roomId`?
    -   Check server console: Is it processing the `key_input` for mode/shift? Is `controllerStateChanged` true? Is it calling `broadcastControllerStateToRoom` for the correct room?
    -   Check controller console: Is it receiving `update_controller_state` events? Are there errors in `updateKeyboardDisplay`?
-   **General Connection Issues:** Check all consoles (server, app, controller). Verify URLs/ports/IPs. Check for network issues.

---

## CHANGELOG

**Recent Changes (Room-Based Hybrid Architecture)**

-   **Architecture:** Refactored to a room-based hybrid model. Server relays core events; App client processes them locally for responsiveness.
-   **Rooms:** Implemented Socket.IO rooms for isolating multiple `app.html` instances. Each app gets its own room.
-   **Short IDs:** Integrated `shortid` library to generate user-friendly, unique Room IDs.
-   **Controller Joining:**
    -   Controllers now join specific rooms via `?room=<shortId>` URL parameter (usually from QR code).
    -   Added manual Room ID entry form as a fallback on `/controller` if the `room` parameter is missing.
-   **Session Persistence:** Implemented `sessionStorage` on `app.html` to remember its Room ID, allowing it to rejoin the same room after a page refresh via a new `rejoin_app_room` server event.
-   **Server State:** Server now manages state per-room using a `roomStates` Map keyed by the short Room ID. State includes `appSocketId`, `controllerSocketIds`, keyboard state, and last known app state for rejoins.
-   **Event Handling:**
    -   Server validates incoming controller events against the specified room's controller list.
    -   Server relays `cursor_move` and `tap` events only to the app owner within the room.
    -   Server processes `key_input` based on *room-specific* keyboard state and relays the result to the app owner. Mode/shift changes update state for all controllers *in that room*.
    -   App reports its state (`report_cursor_position`, `report_focus_change`) back to the server with the Room ID for sync/rejoin purposes.
-   **UX:**
    -   App displays its assigned short Room ID and generates a room-specific QR code.
    -   Controller displays status messages for connection, joining, errors, and disconnections.
    -   Controller UI dynamically shows/hides manual join form vs. main interface.
-   **Code Structure:** Updated server, app, and controller logic to support the room-based flow and short IDs. Added UI management functions to controller.
-   **Dependencies:** Added `shortid` to `package.json`.